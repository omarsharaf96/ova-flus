openapi: 3.0.3
info:
  title: OvaFlus API
  version: 1.0.0
  description: |
    OvaFlus personal finance management API. Provides endpoints for authentication,
    budgeting, transaction tracking, investment portfolio management, market data,
    analytics, and notifications.
  contact:
    name: OvaFlus Engineering
  license:
    name: MIT

servers:
  - url: http://localhost:8080/api/v1
    description: Local development
  - url: https://api-staging.ovaflus.com/v1
    description: Staging
  - url: https://api.ovaflus.com/v1
    description: Production

tags:
  - name: auth
    description: Authentication and user management
  - name: budgets
    description: Budget creation and tracking
  - name: transactions
    description: Transaction management
  - name: portfolio
    description: Investment portfolio management
  - name: market-data
    description: Stock market data and search
  - name: analytics
    description: Financial analytics and reports
  - name: notifications
    description: User notifications and preferences
  - name: plaid
    description: Plaid bank account integration

security:
  - BearerAuth: []

paths:
  # ──────────────────────────── Auth ────────────────────────────
  /auth/register:
    post:
      tags: [auth]
      summary: Register a new user
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RegisterRequest'
      responses:
        '201':
          description: User registered successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '422':
          $ref: '#/components/responses/UnprocessableEntity'

  /auth/login:
    post:
      tags: [auth]
      summary: Authenticate user
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LoginRequest'
      responses:
        '200':
          description: Login successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /auth/refresh:
    post:
      tags: [auth]
      summary: Refresh access token
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [refreshToken]
              properties:
                refreshToken:
                  type: string
      responses:
        '200':
          description: Token refreshed
          content:
            application/json:
              schema:
                type: object
                properties:
                  accessToken:
                    type: string
                  expiresIn:
                    type: integer
        '401':
          $ref: '#/components/responses/Unauthorized'

  /auth/logout:
    post:
      tags: [auth]
      summary: Logout and invalidate tokens
      responses:
        '204':
          description: Logged out successfully
        '401':
          $ref: '#/components/responses/Unauthorized'

  /auth/me:
    get:
      tags: [auth]
      summary: Get current user profile
      responses:
        '200':
          description: User profile
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
        '401':
          $ref: '#/components/responses/Unauthorized'
    put:
      tags: [auth]
      summary: Update current user profile
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateUserRequest'
      responses:
        '200':
          description: Profile updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '422':
          $ref: '#/components/responses/UnprocessableEntity'

  /auth/mfa/setup:
    post:
      tags: [auth]
      summary: Set up multi-factor authentication
      responses:
        '200':
          description: MFA setup initiated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MfaSetupResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /auth/mfa/verify:
    post:
      tags: [auth]
      summary: Verify MFA code
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [code]
              properties:
                code:
                  type: string
                  minLength: 6
                  maxLength: 6
      responses:
        '200':
          description: MFA verified
          content:
            application/json:
              schema:
                type: object
                properties:
                  verified:
                    type: boolean
        '401':
          $ref: '#/components/responses/Unauthorized'

  # ──────────────────────────── Budgets ────────────────────────────
  /budgets:
    get:
      tags: [budgets]
      summary: List budgets
      parameters:
        - $ref: '#/components/parameters/PageParam'
        - $ref: '#/components/parameters/LimitParam'
      responses:
        '200':
          description: Paginated list of budgets
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BudgetListResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
    post:
      tags: [budgets]
      summary: Create a budget
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateBudgetRequest'
      responses:
        '201':
          description: Budget created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Budget'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '422':
          $ref: '#/components/responses/UnprocessableEntity'

  /budgets/templates:
    get:
      tags: [budgets]
      summary: List budget templates
      responses:
        '200':
          description: Available budget templates
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/BudgetTemplate'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /budgets/{id}:
    get:
      tags: [budgets]
      summary: Get a budget
      parameters:
        - $ref: '#/components/parameters/IdParam'
      responses:
        '200':
          description: Budget details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Budget'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
    put:
      tags: [budgets]
      summary: Update a budget
      parameters:
        - $ref: '#/components/parameters/IdParam'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateBudgetRequest'
      responses:
        '200':
          description: Budget updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Budget'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
        '422':
          $ref: '#/components/responses/UnprocessableEntity'
    delete:
      tags: [budgets]
      summary: Delete a budget
      parameters:
        - $ref: '#/components/parameters/IdParam'
      responses:
        '204':
          description: Budget deleted
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

  /budgets/{id}/categories:
    get:
      tags: [budgets]
      summary: List budget categories
      parameters:
        - $ref: '#/components/parameters/IdParam'
      responses:
        '200':
          description: Budget categories
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/BudgetCategory'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
    post:
      tags: [budgets]
      summary: Add a category to a budget
      parameters:
        - $ref: '#/components/parameters/IdParam'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateBudgetCategoryRequest'
      responses:
        '201':
          description: Category added
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BudgetCategory'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
        '422':
          $ref: '#/components/responses/UnprocessableEntity'

  /budgets/{id}/categories/{categoryId}:
    put:
      tags: [budgets]
      summary: Update a budget category
      parameters:
        - $ref: '#/components/parameters/IdParam'
        - name: categoryId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateBudgetCategoryRequest'
      responses:
        '200':
          description: Category updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BudgetCategory'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
    delete:
      tags: [budgets]
      summary: Delete a budget category
      parameters:
        - $ref: '#/components/parameters/IdParam'
        - name: categoryId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '204':
          description: Category deleted
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

  /budgets/{id}/summary:
    get:
      tags: [budgets]
      summary: Get budget summary (spent, remaining, alerts)
      parameters:
        - $ref: '#/components/parameters/IdParam'
      responses:
        '200':
          description: Budget summary
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BudgetSummary'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

  # ──────────────────────────── Transactions ────────────────────────────
  /transactions:
    get:
      tags: [transactions]
      summary: List transactions
      parameters:
        - $ref: '#/components/parameters/PageParam'
        - $ref: '#/components/parameters/LimitParam'
        - name: startDate
          in: query
          schema:
            type: string
            format: date
        - name: endDate
          in: query
          schema:
            type: string
            format: date
        - name: categoryId
          in: query
          schema:
            type: string
            format: uuid
        - name: type
          in: query
          schema:
            type: string
            enum: [income, expense, transfer]
        - name: search
          in: query
          schema:
            type: string
      responses:
        '200':
          description: Paginated transactions
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TransactionListResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
    post:
      tags: [transactions]
      summary: Create a transaction
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateTransactionRequest'
      responses:
        '201':
          description: Transaction created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Transaction'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '422':
          $ref: '#/components/responses/UnprocessableEntity'

  /transactions/{id}:
    get:
      tags: [transactions]
      summary: Get a transaction
      parameters:
        - $ref: '#/components/parameters/IdParam'
      responses:
        '200':
          description: Transaction details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Transaction'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
    put:
      tags: [transactions]
      summary: Update a transaction
      parameters:
        - $ref: '#/components/parameters/IdParam'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateTransactionRequest'
      responses:
        '200':
          description: Transaction updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Transaction'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
        '422':
          $ref: '#/components/responses/UnprocessableEntity'
    delete:
      tags: [transactions]
      summary: Delete a transaction
      parameters:
        - $ref: '#/components/parameters/IdParam'
      responses:
        '204':
          description: Transaction deleted
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

  /transactions/summary:
    get:
      tags: [transactions]
      summary: Get transaction summary by category and period
      parameters:
        - name: period
          in: query
          schema:
            type: string
            enum: [daily, weekly, monthly, yearly]
            default: monthly
        - name: startDate
          in: query
          schema:
            type: string
            format: date
        - name: endDate
          in: query
          schema:
            type: string
            format: date
      responses:
        '200':
          description: Transaction summary
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TransactionSummary'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /transactions/import:
    post:
      tags: [transactions]
      summary: Import transactions from CSV
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required: [file]
              properties:
                file:
                  type: string
                  format: binary
      responses:
        '200':
          description: Import results
          content:
            application/json:
              schema:
                type: object
                properties:
                  imported:
                    type: integer
                  skipped:
                    type: integer
                  errors:
                    type: array
                    items:
                      type: object
                      properties:
                        row:
                          type: integer
                        message:
                          type: string
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /transactions/export:
    get:
      tags: [transactions]
      summary: Export transactions
      parameters:
        - name: format
          in: query
          required: true
          schema:
            type: string
            enum: [csv, pdf]
        - name: startDate
          in: query
          schema:
            type: string
            format: date
        - name: endDate
          in: query
          schema:
            type: string
            format: date
      responses:
        '200':
          description: File download
          content:
            text/csv:
              schema:
                type: string
                format: binary
            application/pdf:
              schema:
                type: string
                format: binary
        '401':
          $ref: '#/components/responses/Unauthorized'

  /income:
    get:
      tags: [transactions]
      summary: List income sources
      responses:
        '200':
          description: Income sources
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/IncomeSource'
        '401':
          $ref: '#/components/responses/Unauthorized'
    post:
      tags: [transactions]
      summary: Add an income source
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateIncomeSourceRequest'
      responses:
        '201':
          description: Income source created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/IncomeSource'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '422':
          $ref: '#/components/responses/UnprocessableEntity'

  /recurring:
    get:
      tags: [transactions]
      summary: List recurring transactions
      responses:
        '200':
          description: Recurring transactions
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/RecurringTransaction'
        '401':
          $ref: '#/components/responses/Unauthorized'
    post:
      tags: [transactions]
      summary: Create a recurring transaction
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateRecurringTransactionRequest'
      responses:
        '201':
          description: Recurring transaction created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RecurringTransaction'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '422':
          $ref: '#/components/responses/UnprocessableEntity'

  # ──────────────────────────── Portfolio ────────────────────────────
  /portfolios:
    get:
      tags: [portfolio]
      summary: List portfolios
      responses:
        '200':
          description: Portfolios
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/Portfolio'
        '401':
          $ref: '#/components/responses/Unauthorized'
    post:
      tags: [portfolio]
      summary: Create a portfolio
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreatePortfolioRequest'
      responses:
        '201':
          description: Portfolio created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Portfolio'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '422':
          $ref: '#/components/responses/UnprocessableEntity'

  /portfolios/{id}:
    get:
      tags: [portfolio]
      summary: Get a portfolio
      parameters:
        - $ref: '#/components/parameters/IdParam'
      responses:
        '200':
          description: Portfolio details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Portfolio'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
    put:
      tags: [portfolio]
      summary: Update a portfolio
      parameters:
        - $ref: '#/components/parameters/IdParam'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdatePortfolioRequest'
      responses:
        '200':
          description: Portfolio updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Portfolio'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
    delete:
      tags: [portfolio]
      summary: Delete a portfolio
      parameters:
        - $ref: '#/components/parameters/IdParam'
      responses:
        '204':
          description: Portfolio deleted
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

  /portfolios/{id}/holdings:
    get:
      tags: [portfolio]
      summary: List holdings in a portfolio
      parameters:
        - $ref: '#/components/parameters/IdParam'
      responses:
        '200':
          description: Portfolio holdings
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/Holding'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
    post:
      tags: [portfolio]
      summary: Add a holding to a portfolio
      parameters:
        - $ref: '#/components/parameters/IdParam'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AddHoldingRequest'
      responses:
        '201':
          description: Holding added
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Holding'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
        '422':
          $ref: '#/components/responses/UnprocessableEntity'

  /portfolios/{id}/holdings/{holdingId}:
    put:
      tags: [portfolio]
      summary: Update a holding
      parameters:
        - $ref: '#/components/parameters/IdParam'
        - name: holdingId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateHoldingRequest'
      responses:
        '200':
          description: Holding updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Holding'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
    delete:
      tags: [portfolio]
      summary: Remove a holding from a portfolio
      parameters:
        - $ref: '#/components/parameters/IdParam'
        - name: holdingId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '204':
          description: Holding removed
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

  /portfolios/{id}/performance:
    get:
      tags: [portfolio]
      summary: Get portfolio performance
      parameters:
        - $ref: '#/components/parameters/IdParam'
        - name: timeframe
          in: query
          schema:
            type: string
            enum: [1W, 1M, 3M, 6M, 1Y, ALL]
            default: 1M
      responses:
        '200':
          description: Portfolio performance data
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PortfolioPerformance'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

  /portfolios/{id}/allocation:
    get:
      tags: [portfolio]
      summary: Get portfolio allocation breakdown
      parameters:
        - $ref: '#/components/parameters/IdParam'
      responses:
        '200':
          description: Portfolio allocation
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PortfolioAllocation'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

  /watchlists:
    get:
      tags: [portfolio]
      summary: List watchlists
      responses:
        '200':
          description: Watchlists
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/Watchlist'
        '401':
          $ref: '#/components/responses/Unauthorized'
    post:
      tags: [portfolio]
      summary: Create a watchlist
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [name]
              properties:
                name:
                  type: string
      responses:
        '201':
          description: Watchlist created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Watchlist'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /watchlists/{id}/items:
    post:
      tags: [portfolio]
      summary: Add item to watchlist
      parameters:
        - $ref: '#/components/parameters/IdParam'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [symbol]
              properties:
                symbol:
                  type: string
      responses:
        '201':
          description: Item added
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WatchlistItem'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

  /watchlists/{id}/items/{symbol}:
    delete:
      tags: [portfolio]
      summary: Remove item from watchlist
      parameters:
        - $ref: '#/components/parameters/IdParam'
        - name: symbol
          in: path
          required: true
          schema:
            type: string
      responses:
        '204':
          description: Item removed
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

  # ──────────────────────────── Market Data ────────────────────────────
  /market/stocks/{symbol}/quote:
    get:
      tags: [market-data]
      summary: Get stock quote
      parameters:
        - name: symbol
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Stock quote
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StockQuote'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

  /market/stocks/{symbol}/history:
    get:
      tags: [market-data]
      summary: Get stock price history
      parameters:
        - name: symbol
          in: path
          required: true
          schema:
            type: string
        - name: timeframe
          in: query
          schema:
            type: string
            enum: [1W, 1M, 3M, 6M, 1Y, 5Y, ALL]
            default: 1M
      responses:
        '200':
          description: Historical prices
          content:
            application/json:
              schema:
                type: object
                properties:
                  symbol:
                    type: string
                  timeframe:
                    type: string
                  prices:
                    type: array
                    items:
                      $ref: '#/components/schemas/HistoricalPrice'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

  /market/stocks/search:
    get:
      tags: [market-data]
      summary: Search stocks
      parameters:
        - name: q
          in: query
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Search results
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/StockQuote'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /market/stocks/{symbol}/news:
    get:
      tags: [market-data]
      summary: Get news for a stock
      parameters:
        - name: symbol
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Stock news
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/StockNews'
        '401':
          $ref: '#/components/responses/Unauthorized'

  # ──────────────────────────── Analytics ────────────────────────────
  /analytics/spending-summary:
    get:
      tags: [analytics]
      summary: Get spending summary
      parameters:
        - name: period
          in: query
          schema:
            type: string
            enum: [weekly, monthly, quarterly, yearly]
            default: monthly
      responses:
        '200':
          description: Spending summary
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SpendingSummary'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /analytics/budget-vs-actual:
    get:
      tags: [analytics]
      summary: Get budget vs actual comparison
      parameters:
        - name: budgetId
          in: query
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Budget vs actual data
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BudgetVsActual'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /analytics/trends:
    get:
      tags: [analytics]
      summary: Get financial trends
      parameters:
        - name: months
          in: query
          schema:
            type: integer
            default: 6
            minimum: 1
            maximum: 24
      responses:
        '200':
          description: Trend data
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TrendData'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /analytics/portfolio-performance:
    get:
      tags: [analytics]
      summary: Get aggregate portfolio performance analytics
      responses:
        '200':
          description: Portfolio performance analytics
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PortfolioAnalytics'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /reports/generate:
    post:
      tags: [analytics]
      summary: Generate a financial report
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/GenerateReportRequest'
      responses:
        '202':
          description: Report generation started
          content:
            application/json:
              schema:
                type: object
                properties:
                  reportId:
                    type: string
                    format: uuid
                  status:
                    type: string
                    enum: [pending, processing]
                  estimatedCompletionAt:
                    type: string
                    format: date-time
        '401':
          $ref: '#/components/responses/Unauthorized'
        '422':
          $ref: '#/components/responses/UnprocessableEntity'

  # ──────────────────────────── Notifications ────────────────────────────
  /notifications:
    get:
      tags: [notifications]
      summary: List notifications
      parameters:
        - name: unreadOnly
          in: query
          schema:
            type: boolean
            default: false
      responses:
        '200':
          description: Notifications
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/Notification'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /notifications/{id}/read:
    put:
      tags: [notifications]
      summary: Mark notification as read
      parameters:
        - $ref: '#/components/parameters/IdParam'
      responses:
        '200':
          description: Notification marked as read
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Notification'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

  /notifications/read-all:
    put:
      tags: [notifications]
      summary: Mark all notifications as read
      responses:
        '200':
          description: All notifications marked as read
          content:
            application/json:
              schema:
                type: object
                properties:
                  updatedCount:
                    type: integer
        '401':
          $ref: '#/components/responses/Unauthorized'

  /notifications/preferences:
    get:
      tags: [notifications]
      summary: Get notification preferences
      responses:
        '200':
          description: Notification preferences
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/NotificationPreferences'
        '401':
          $ref: '#/components/responses/Unauthorized'
    put:
      tags: [notifications]
      summary: Update notification preferences
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/NotificationPreferences'
      responses:
        '200':
          description: Preferences updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/NotificationPreferences'
        '401':
          $ref: '#/components/responses/Unauthorized'

  # ──────────────────────────── Plaid ────────────────────────────
  /plaid/webhooks:
    post:
      tags: [plaid]
      summary: Receive Plaid webhook events
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PlaidWebhookPayload'
      responses:
        '200':
          description: Webhook received

  /plaid/link-token:
    post:
      tags: [plaid]
      summary: Create a Plaid Link token
      responses:
        '200':
          description: Link token created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CreateLinkTokenResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /plaid/exchange-token:
    post:
      tags: [plaid]
      summary: Exchange public token for access token
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ExchangeTokenRequest'
      responses:
        '200':
          description: Token exchanged successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ExchangeTokenResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /plaid/accounts:
    get:
      tags: [plaid]
      summary: List linked bank accounts
      responses:
        '200':
          description: List of linked accounts
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/BankAccount'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /plaid/sync:
    post:
      tags: [plaid]
      summary: Sync transactions from Plaid
      responses:
        '200':
          description: Sync completed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SyncTransactionsResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /plaid/accounts/{id}:
    delete:
      tags: [plaid]
      summary: Unlink a bank account
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '204':
          description: Account unlinked successfully
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

# ════════════════════════════════════════════════════════════════════
# Components
# ════════════════════════════════════════════════════════════════════
components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
    ApiKeyAuth:
      type: apiKey
      in: header
      name: X-API-Key

  parameters:
    IdParam:
      name: id
      in: path
      required: true
      schema:
        type: string
        format: uuid
    PageParam:
      name: page
      in: query
      schema:
        type: integer
        minimum: 1
        default: 1
    LimitParam:
      name: limit
      in: query
      schema:
        type: integer
        minimum: 1
        maximum: 100
        default: 20

  responses:
    BadRequest:
      description: Bad request
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
    Unauthorized:
      description: Authentication required
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
    Forbidden:
      description: Insufficient permissions
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
    UnprocessableEntity:
      description: Validation error
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ValidationError'
    InternalServerError:
      description: Internal server error
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'

  schemas:
    # ── Common ──
    Error:
      type: object
      required: [code, message]
      properties:
        code:
          type: string
        message:
          type: string
        details:
          type: string

    ValidationError:
      type: object
      required: [code, message, errors]
      properties:
        code:
          type: string
          example: VALIDATION_ERROR
        message:
          type: string
        errors:
          type: array
          items:
            type: object
            properties:
              field:
                type: string
              message:
                type: string
              code:
                type: string

    PaginationMeta:
      type: object
      properties:
        page:
          type: integer
        limit:
          type: integer
        totalItems:
          type: integer
        totalPages:
          type: integer

    # ── Auth ──
    User:
      type: object
      properties:
        id:
          type: string
          format: uuid
        email:
          type: string
          format: email
        displayName:
          type: string
        avatar:
          type: string
          format: uri
          nullable: true
        mfaEnabled:
          type: boolean
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    RegisterRequest:
      type: object
      required: [email, password, displayName]
      properties:
        email:
          type: string
          format: email
        password:
          type: string
          minLength: 8
        displayName:
          type: string
          minLength: 1
          maxLength: 100

    LoginRequest:
      type: object
      required: [email, password]
      properties:
        email:
          type: string
          format: email
        password:
          type: string

    AuthResponse:
      type: object
      properties:
        accessToken:
          type: string
        refreshToken:
          type: string
        expiresIn:
          type: integer
        user:
          $ref: '#/components/schemas/User'

    UpdateUserRequest:
      type: object
      properties:
        displayName:
          type: string
          minLength: 1
          maxLength: 100
        avatar:
          type: string
          format: uri

    MfaSetupResponse:
      type: object
      properties:
        secret:
          type: string
        qrCodeUrl:
          type: string
          format: uri

    # ── Budgets ──
    Budget:
      type: object
      properties:
        id:
          type: string
          format: uuid
        userId:
          type: string
          format: uuid
        name:
          type: string
        description:
          type: string
          nullable: true
        amount:
          type: number
          format: double
        currency:
          type: string
          default: USD
        period:
          type: string
          enum: [weekly, biweekly, monthly, quarterly, yearly]
        startDate:
          type: string
          format: date
        endDate:
          type: string
          format: date
          nullable: true
        categories:
          type: array
          items:
            $ref: '#/components/schemas/BudgetCategory'
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    BudgetCategory:
      type: object
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
        allocatedAmount:
          type: number
          format: double
        color:
          type: string
          nullable: true
        icon:
          type: string
          nullable: true

    BudgetTemplate:
      type: object
      properties:
        id:
          type: string
        name:
          type: string
        description:
          type: string
        categories:
          type: array
          items:
            type: object
            properties:
              name:
                type: string
              percentAllocation:
                type: number

    BudgetSummary:
      type: object
      properties:
        budgetId:
          type: string
          format: uuid
        totalBudget:
          type: number
          format: double
        totalSpent:
          type: number
          format: double
        remaining:
          type: number
          format: double
        percentUsed:
          type: number
          format: double
        categoryBreakdown:
          type: array
          items:
            type: object
            properties:
              categoryId:
                type: string
                format: uuid
              categoryName:
                type: string
              allocated:
                type: number
                format: double
              spent:
                type: number
                format: double
              remaining:
                type: number
                format: double
        alerts:
          type: array
          items:
            type: object
            properties:
              type:
                type: string
                enum: [warning, exceeded]
              message:
                type: string
              categoryId:
                type: string
                format: uuid
                nullable: true

    CreateBudgetRequest:
      type: object
      required: [name, amount, period, startDate]
      properties:
        name:
          type: string
        description:
          type: string
        amount:
          type: number
          format: double
          minimum: 0
        currency:
          type: string
          default: USD
        period:
          type: string
          enum: [weekly, biweekly, monthly, quarterly, yearly]
        startDate:
          type: string
          format: date
        endDate:
          type: string
          format: date
        templateId:
          type: string

    UpdateBudgetRequest:
      type: object
      properties:
        name:
          type: string
        description:
          type: string
        amount:
          type: number
          format: double
          minimum: 0
        period:
          type: string
          enum: [weekly, biweekly, monthly, quarterly, yearly]
        endDate:
          type: string
          format: date

    CreateBudgetCategoryRequest:
      type: object
      required: [name, allocatedAmount]
      properties:
        name:
          type: string
        allocatedAmount:
          type: number
          format: double
          minimum: 0
        color:
          type: string
        icon:
          type: string

    UpdateBudgetCategoryRequest:
      type: object
      properties:
        name:
          type: string
        allocatedAmount:
          type: number
          format: double
          minimum: 0
        color:
          type: string
        icon:
          type: string

    BudgetListResponse:
      type: object
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/Budget'
        meta:
          $ref: '#/components/schemas/PaginationMeta'

    # ── Transactions ──
    Transaction:
      type: object
      properties:
        id:
          type: string
          format: uuid
        userId:
          type: string
          format: uuid
        type:
          type: string
          enum: [income, expense, transfer]
        amount:
          type: number
          format: double
        currency:
          type: string
        description:
          type: string
        categoryId:
          type: string
          format: uuid
          nullable: true
        categoryName:
          type: string
          nullable: true
        date:
          type: string
          format: date
        merchant:
          type: string
          nullable: true
        notes:
          type: string
          nullable: true
        tags:
          type: array
          items:
            type: string
        isRecurring:
          type: boolean
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    CreateTransactionRequest:
      type: object
      required: [type, amount, description, date]
      properties:
        type:
          type: string
          enum: [income, expense, transfer]
        amount:
          type: number
          format: double
          minimum: 0
        currency:
          type: string
          default: USD
        description:
          type: string
        categoryId:
          type: string
          format: uuid
        date:
          type: string
          format: date
        merchant:
          type: string
        notes:
          type: string
        tags:
          type: array
          items:
            type: string

    UpdateTransactionRequest:
      type: object
      properties:
        type:
          type: string
          enum: [income, expense, transfer]
        amount:
          type: number
          format: double
          minimum: 0
        description:
          type: string
        categoryId:
          type: string
          format: uuid
        date:
          type: string
          format: date
        merchant:
          type: string
        notes:
          type: string
        tags:
          type: array
          items:
            type: string

    TransactionListResponse:
      type: object
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/Transaction'
        meta:
          $ref: '#/components/schemas/PaginationMeta'

    TransactionSummary:
      type: object
      properties:
        totalIncome:
          type: number
          format: double
        totalExpenses:
          type: number
          format: double
        netAmount:
          type: number
          format: double
        byCategory:
          type: array
          items:
            type: object
            properties:
              categoryId:
                type: string
                format: uuid
              categoryName:
                type: string
              total:
                type: number
                format: double
              transactionCount:
                type: integer
        byPeriod:
          type: array
          items:
            type: object
            properties:
              period:
                type: string
              income:
                type: number
                format: double
              expenses:
                type: number
                format: double

    IncomeSource:
      type: object
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
        amount:
          type: number
          format: double
        frequency:
          type: string
          enum: [one-time, weekly, biweekly, monthly, quarterly, yearly]
        isActive:
          type: boolean
        createdAt:
          type: string
          format: date-time

    CreateIncomeSourceRequest:
      type: object
      required: [name, amount, frequency]
      properties:
        name:
          type: string
        amount:
          type: number
          format: double
          minimum: 0
        frequency:
          type: string
          enum: [one-time, weekly, biweekly, monthly, quarterly, yearly]

    RecurringTransaction:
      type: object
      properties:
        id:
          type: string
          format: uuid
        type:
          type: string
          enum: [income, expense]
        amount:
          type: number
          format: double
        description:
          type: string
        categoryId:
          type: string
          format: uuid
          nullable: true
        frequency:
          type: string
          enum: [daily, weekly, biweekly, monthly, quarterly, yearly]
        nextOccurrence:
          type: string
          format: date
        isActive:
          type: boolean
        createdAt:
          type: string
          format: date-time

    CreateRecurringTransactionRequest:
      type: object
      required: [type, amount, description, frequency, startDate]
      properties:
        type:
          type: string
          enum: [income, expense]
        amount:
          type: number
          format: double
          minimum: 0
        description:
          type: string
        categoryId:
          type: string
          format: uuid
        frequency:
          type: string
          enum: [daily, weekly, biweekly, monthly, quarterly, yearly]
        startDate:
          type: string
          format: date
        endDate:
          type: string
          format: date

    # ── Portfolio ──
    Portfolio:
      type: object
      properties:
        id:
          type: string
          format: uuid
        userId:
          type: string
          format: uuid
        name:
          type: string
        description:
          type: string
          nullable: true
        totalValue:
          type: number
          format: double
        totalGainLoss:
          type: number
          format: double
        totalGainLossPercent:
          type: number
          format: double
        holdings:
          type: array
          items:
            $ref: '#/components/schemas/Holding'
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    Holding:
      type: object
      properties:
        id:
          type: string
          format: uuid
        symbol:
          type: string
        name:
          type: string
        shares:
          type: number
          format: double
        averageCost:
          type: number
          format: double
        currentPrice:
          type: number
          format: double
        totalValue:
          type: number
          format: double
        gainLoss:
          type: number
          format: double
        gainLossPercent:
          type: number
          format: double
        createdAt:
          type: string
          format: date-time

    CreatePortfolioRequest:
      type: object
      required: [name]
      properties:
        name:
          type: string
        description:
          type: string

    UpdatePortfolioRequest:
      type: object
      properties:
        name:
          type: string
        description:
          type: string

    AddHoldingRequest:
      type: object
      required: [symbol, shares, averageCost]
      properties:
        symbol:
          type: string
        shares:
          type: number
          format: double
          minimum: 0
        averageCost:
          type: number
          format: double
          minimum: 0

    UpdateHoldingRequest:
      type: object
      properties:
        shares:
          type: number
          format: double
          minimum: 0
        averageCost:
          type: number
          format: double
          minimum: 0

    PortfolioPerformance:
      type: object
      properties:
        portfolioId:
          type: string
          format: uuid
        timeframe:
          type: string
        totalReturn:
          type: number
          format: double
        totalReturnPercent:
          type: number
          format: double
        dataPoints:
          type: array
          items:
            type: object
            properties:
              date:
                type: string
                format: date
              value:
                type: number
                format: double

    PortfolioAllocation:
      type: object
      properties:
        portfolioId:
          type: string
          format: uuid
        totalValue:
          type: number
          format: double
        allocations:
          type: array
          items:
            type: object
            properties:
              symbol:
                type: string
              name:
                type: string
              value:
                type: number
                format: double
              percentage:
                type: number
                format: double
              sector:
                type: string
                nullable: true

    Watchlist:
      type: object
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
        items:
          type: array
          items:
            $ref: '#/components/schemas/WatchlistItem'
        createdAt:
          type: string
          format: date-time

    WatchlistItem:
      type: object
      properties:
        symbol:
          type: string
        name:
          type: string
        currentPrice:
          type: number
          format: double
        change:
          type: number
          format: double
        changePercent:
          type: number
          format: double
        addedAt:
          type: string
          format: date-time

    # ── Market Data ──
    StockQuote:
      type: object
      properties:
        symbol:
          type: string
        name:
          type: string
        exchange:
          type: string
        currentPrice:
          type: number
          format: double
        change:
          type: number
          format: double
        changePercent:
          type: number
          format: double
        high:
          type: number
          format: double
        low:
          type: number
          format: double
        open:
          type: number
          format: double
        previousClose:
          type: number
          format: double
        volume:
          type: integer
          format: int64
        marketCap:
          type: number
          format: double
          nullable: true
        updatedAt:
          type: string
          format: date-time

    HistoricalPrice:
      type: object
      properties:
        date:
          type: string
          format: date
        open:
          type: number
          format: double
        high:
          type: number
          format: double
        low:
          type: number
          format: double
        close:
          type: number
          format: double
        volume:
          type: integer
          format: int64

    StockNews:
      type: object
      properties:
        id:
          type: string
        title:
          type: string
        summary:
          type: string
        source:
          type: string
        url:
          type: string
          format: uri
        publishedAt:
          type: string
          format: date-time
        sentiment:
          type: string
          enum: [positive, negative, neutral]
          nullable: true

    # ── Analytics ──
    SpendingSummary:
      type: object
      properties:
        period:
          type: string
        totalSpent:
          type: number
          format: double
        comparedToPrevious:
          type: number
          format: double
        categories:
          type: array
          items:
            type: object
            properties:
              categoryName:
                type: string
              amount:
                type: number
                format: double
              percentage:
                type: number
                format: double
              trend:
                type: string
                enum: [up, down, stable]

    BudgetVsActual:
      type: object
      properties:
        budgetId:
          type: string
          format: uuid
        budgetName:
          type: string
        categories:
          type: array
          items:
            type: object
            properties:
              categoryName:
                type: string
              budgeted:
                type: number
                format: double
              actual:
                type: number
                format: double
              variance:
                type: number
                format: double
              variancePercent:
                type: number
                format: double

    TrendData:
      type: object
      properties:
        months:
          type: integer
        income:
          type: array
          items:
            type: object
            properties:
              month:
                type: string
              amount:
                type: number
                format: double
        expenses:
          type: array
          items:
            type: object
            properties:
              month:
                type: string
              amount:
                type: number
                format: double
        savings:
          type: array
          items:
            type: object
            properties:
              month:
                type: string
              amount:
                type: number
                format: double

    PortfolioAnalytics:
      type: object
      properties:
        totalValue:
          type: number
          format: double
        totalInvested:
          type: number
          format: double
        totalReturn:
          type: number
          format: double
        totalReturnPercent:
          type: number
          format: double
        topPerformers:
          type: array
          items:
            type: object
            properties:
              symbol:
                type: string
              name:
                type: string
              returnPercent:
                type: number
                format: double
        sectorAllocation:
          type: array
          items:
            type: object
            properties:
              sector:
                type: string
              percentage:
                type: number
                format: double

    GenerateReportRequest:
      type: object
      required: [type, format, dateRange]
      properties:
        type:
          type: string
          enum: [spending, income, budget, portfolio, tax]
        format:
          type: string
          enum: [pdf, csv, xlsx]
        dateRange:
          type: object
          required: [startDate, endDate]
          properties:
            startDate:
              type: string
              format: date
            endDate:
              type: string
              format: date

    # ── Notifications ──
    Notification:
      type: object
      properties:
        id:
          type: string
          format: uuid
        userId:
          type: string
          format: uuid
        type:
          type: string
          enum: [budget_alert, transaction, portfolio, system, reminder]
        title:
          type: string
        message:
          type: string
        isRead:
          type: boolean
        data:
          type: object
          additionalProperties: true
          nullable: true
        createdAt:
          type: string
          format: date-time

    NotificationPreferences:
      type: object
      properties:
        email:
          type: object
          properties:
            enabled:
              type: boolean
            budgetAlerts:
              type: boolean
            transactionAlerts:
              type: boolean
            portfolioAlerts:
              type: boolean
            weeklyDigest:
              type: boolean
        push:
          type: object
          properties:
            enabled:
              type: boolean
            budgetAlerts:
              type: boolean
            transactionAlerts:
              type: boolean
            portfolioAlerts:
              type: boolean
            priceAlerts:
              type: boolean
        inApp:
          type: object
          properties:
            enabled:
              type: boolean
